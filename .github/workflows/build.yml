name: Build Multi-Platform Executables

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
        python-version: ["3.11"]

    runs-on: ${{ matrix.os }}
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install macOS dependencies
      if: runner.os == 'macOS'
      shell: bash
      run: brew install pkg-config libffi
      
    - name: Install Linux dependencies
      if: runner.os == 'Linux'
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1-mesa-dev libxkbcommon-x11-0

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt5 pyinstaller

    - name: Embed resources
      run: python embed_resources.py

    # 平台无关的资源验证
    - name: Verify qt_plugins exists
      run: |
        echo "验证 qt_plugins 目录..."
        if [ -d "qt_plugins" ]; then
          echo "qt_plugins 目录存在"
          echo "目录内容:"
          ls -lR qt_plugins || echo "目录列表失败"
        else
          echo "错误: qt_plugins 目录不存在!"
          exit 1
        fi
      shell: bash

    # macOS 构建
    - name: Build on macOS
      if: runner.os == 'macOS'
      shell: bash
      run: |
        PROJECT_ROOT=$(pwd)
        pyinstaller --onedir --windowed \
          --name HiveToCKConverter \
          --add-data "$PROJECT_ROOT/qt_plugins:qt_plugins" \
          --osx-bundle-identifier "com.example.HiveToCKConverter" \
          app.py
        mv dist/HiveToCKConverter.app dist/HiveToCKConverter
        echo "asset_name=HiveToCKConverter-macOS.app" >> $GITHUB_OUTPUT

    # Windows 构建
    - name: Build on Windows
      if: runner.os == 'Windows'
      run: |
        $PROJECT_ROOT = Get-Location
        pyinstaller --onefile --windowed --name HiveToCKConverter --add-data "$PROJECT_ROOT\qt_plugins;qt_plugins" app.py
        echo "asset_name=HiveToCKConverter-Windows.exe" >> $env:GITHUB_OUTPUT
      shell: powershell

    # Linux 构建
    - name: Build on Linux
      if: runner.os == 'Linux'
      shell: bash
      run: |
        PROJECT_ROOT=$(pwd)
        pyinstaller --onefile --name HiveToCKConverter --add-data "$PROJECT_ROOT/qt_plugins:qt_plugins" app.py
        echo "asset_name=HiveToCKConverter-Linux" >> $GITHUB_OUTPUT

    # 工件上传
    - name: Upload macOS artifact
      if: runner.os == 'macOS'
      uses: actions/upload-artifact@v4
      with:
        name: HiveToCKConverter-macOS.app
        path: dist/HiveToCKConverter.app

    - name: Upload Windows artifact
      if: runner.os == 'Windows'
      uses: actions/upload-artifact@v4
      with:
        name: HiveToCKConverter-Windows.exe
        path: dist/HiveToCKConverter.exe

    - name: Upload Linux artifact
      if: runner.os == 'Linux'
      uses: actions/upload-artifact@v4
      with:
        name: HiveToCKConverter-Linux
        path: dist/HiveToCKConverter

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 30

    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_id }}
        name: Release v${{ github.run_id }}
        body: |
          Multi-platform build for:
          - Windows
          - macOS
          - Linux
        files: |
          artifacts/*
